# 项目需求文档

## 项目名称
PPSD 批量处理与可视化工具

## 项目简介
本项目旨在为地震学数据分析提供一套命令行工具，支持批量计算和可视化概率功率谱密度（PPSD, Probabilistic Power Spectral Density）。工具基于 ObsPy 库，支持数据的导入、PPSD 计算、结果保存、批量绘图及交互式分析。

## 主要功能

### 1. 数据导入与PPSD计算
- 支持批量导入地震数据文件（如 miniSEED）。
- 支持通过 ObsPy Inventory 文件自动加载仪器响应。
- 自动检测并复用已存在的 PPSD 数据文件，避免重复计算。
- 支持自定义数据格式和输出文件前缀。
- 所有处理过程均有详细日志记录。

### 2. PPSD 绘图
- 支持批量绘制标准 PPSD 图（概率功率谱密度分布）。
- 支持批量绘制 PPSD 随时间变化的图（temporal plot）。
- 支持批量绘制 PPSD 频谱图（spectrogram）。
- 所有绘图均强制使用统一的颜色映射（如 obspy_divergent）。
- 支持自定义输出文件前缀和后缀。

### 3. 交互式分析
- 支持加载单个 PPSD 文件并自动进入 IPython 交互环境，便于进一步分析。

### 4. 命令行接口
- 提供统一的命令行入口，支持以下子命令：
  - `add`：批量添加数据并生成/更新 PPSD 文件
  - `plot`：批量绘制标准 PPSD 图
  - `timeplot`：批量绘制 PPSD 随时间变化图
  - `spectrogram`：批量绘制 PPSD 频谱图
  - `load`：加载单个 PPSD 进入 IPython
- 所有命令均支持参数自动补全和详细帮助信息。
- 支持 `--pdb` 参数，异常时自动进入调试模式。

### 5. 错误处理与日志
- 所有关键步骤均有异常捕获和详细日志输出，便于追踪和调试。
- 日志同时输出到文件和终端。

## 依赖环境
- Python 3.x
- ObsPy
- matplotlib
- tqdm（可选，用于进度条显示）
- IPython（可选，用于交互式分析）

## 约束与规范
- 所有输出文件命名遵循统一格式（如 `ppsd_data_{id}.npz`）。
- 代码风格应保持一致，变量命名需具备描述性。
- 需考虑边界情况和异常处理，保证批量处理的健壮性。
- 不允许硬编码魔法数字，需使用常量。
- 日志记录需详尽，便于后期问题追踪。

## 安全与性能
- 需优先考虑数据处理的性能，避免重复计算。
- 需保证文件操作的安全性，防止数据丢失或覆盖。

## 数学公式说明

### 功率谱（Power Spectral Density, PSD）

功率谱密度（PSD）用于描述信号在不同频率上的功率分布。其计算通常基于离散傅里叶变换（DFT）：

```
PSD(f) = (1 / (N * f_s)) * |Σ_{n=0}^{N-1} x[n] * exp(-j * 2π * f * n / f_s)|^2
```

其中：
- x[n]：离散时间信号
- N：采样点数
- f_s：采样频率
- f：频率

### 概率功率谱密度（Probabilistic Power Spectral Density, PPSD）

PPSD 是对多个时间窗口内 PSD 结果的统计分布（概率密度函数，PDF），常用直方图统计法实现。其核心思想是：
- 将每个时间段的 PSD 结果累积到频率-功率二维直方图中，统计每个功率区间出现的概率。
- 归一化后，得到每个频率点上功率的概率分布。

PPSD 的 PDF 计算可表示为：

```
PDF(f, p) = （在频率 f 上，功率落入区间 p 的次数）/（总的时间窗口数）
```

其中：
- f：频率
- p：功率区间

详细的 PPSD 计算和参数说明可参考 ObsPy 官方文档：[ObsPy PPSD API](https://docs.obspy.org/packages/autogen/obspy.signal.spectral_estimation.PPSD.html#obspy.signal.spectral_estimation.PPSD)
