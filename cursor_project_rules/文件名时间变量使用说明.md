# PPSD文件名时间变量使用说明

## 概述

PPSD项目的配置文件支持在文件名模式中使用时间变量，包括开始时间和结束时间变量。这些变量来自于数据的实际时间范围，可以用于生成包含详细时间信息的文件名。

## 支持的时间变量

### 开始时间变量
- `{start_datetime}` - 紧凑格式的开始时间戳 (YYYYMMDDHHMM)
- `{start_year}` - 开始年份 (YYYY)
- `{start_month}` - 开始月份 (MM)
- `{start_day}` - 开始日期 (DD)
- `{start_hour}` - 开始小时 (HH)
- `{start_minute}` - 开始分钟 (MM)
- `{start_second}` - 开始秒钟 (SS)
- `{start_julday}` - 开始年积日 (001-366)

### 结束时间变量
- `{end_datetime}` - 紧凑格式的结束时间戳 (YYYYMMDDHHMM)
- `{end_year}` - 结束年份 (YYYY)
- `{end_month}` - 结束月份 (MM)
- `{end_day}` - 结束日期 (DD)
- `{end_hour}` - 结束小时 (HH)
- `{end_minute}` - 结束分钟 (MM)
- `{end_second}` - 结束秒钟 (SS)
- `{end_julday}` - 结束年积日 (001-366)

### 兼容性变量（等同于开始时间）
- `{datetime}` - 等同于 `{start_datetime}`
- `{year}` - 等同于 `{start_year}`
- `{month}` - 等同于 `{start_month}`
- `{day}` - 等同于 `{start_day}`
- `{hour}` - 等同于 `{start_hour}`
- `{minute}` - 等同于 `{start_minute}`
- `{second}` - 等同于 `{start_second}`
- `{julday}` - 等同于 `{start_julday}`

### 其他变量
- `{plot_type}` - 绘图类型 (standard, temporal, spectrogram)
- `{network}` - 地震台网代码
- `{station}` - 台站代码
- `{location}` - 位置代码
- `{channel}` - 通道代码

## 使用示例

### 1. 基础时间范围文件名
```toml
output_filename_pattern = "{plot_type}_{start_datetime}_{end_datetime}_{network}-{station}-{location}-{channel}.png"
```
生成文件名示例：
- `standard_202503231600_202503261600_BJ-DSQ-00-SHZ.png`
- `temporal_202503231600_202503261600_BJ-DAX-00-BHZ.png`

### 2. 详细时间格式
```toml
output_filename_pattern = "{plot_type}_{start_year}-{start_month:02d}-{start_day:02d}_{start_hour:02d}h{start_minute:02d}m_to_{end_year}-{end_month:02d}-{end_day:02d}_{end_hour:02d}h{end_minute:02d}m_{network}.{station}.{channel}.png"
```
生成文件名示例：
- `standard_2025-03-23_16h00m_to_2025-03-26_16h00m_BJ.DSQ.SHZ.png`

### 3. 仅日期范围
```toml
output_filename_pattern = "{plot_type}_{start_year}{start_month:02d}{start_day:02d}_{end_year}{end_month:02d}{end_day:02d}_{network}_{station}_{channel}.png"
```
生成文件名示例：
- `standard_20250323_20250326_BJ_DSQ_SHZ.png`

### 4. 年积日格式
```toml
output_filename_pattern = "{plot_type}_{start_year}_{start_julday:03d}_{end_year}_{end_julday:03d}_{network}.{station}.{location}.{channel}.png"
```
生成文件名示例：
- `standard_2025_082_2025_085_BJ.DSQ.00.SHZ.png`

### 5. 兼容性格式（仅开始时间）
```toml
output_filename_pattern = "{plot_type}_{datetime}_{network}-{station}-{location}-{channel}.png"
```
生成文件名示例：
- `standard_202503231600_BJ-DSQ-00-SHZ.png`

## 配置文件示例

### 计算配置文件 (config.toml)
```toml
output_npz_filename_pattern = "PPSD_{start_datetime}_{end_datetime}_{network}.{station}.{location}.{channel}.npz"
```

### 绘图配置文件 (config_plot.toml)
```toml
[paths]
output_filename_pattern = "{plot_type}_{start_datetime}_{end_datetime}_{network}-{station}-{location}-{channel}.png"
```

## 时间数据来源

### 计算模式 (config.toml)
- 时间变量来自MiniSEED文件中的实际数据开始和结束时间
- 对于合并的trace，开始时间为最早trace的开始时间，结束时间为最晚trace的结束时间

### 绘图模式 (config_plot.toml)
- 时间变量来自PPSD对象中已处理的时间段
- 对于合并的NPZ文件，开始时间为最早时间段，结束时间为最晚时间段

## 注意事项

1. **时间精度**：时间变量精确到分钟级别，秒钟信息也可用但通常用于精细控制
2. **文件名合法性**：生成的文件名会自动处理特殊字符，确保文件系统兼容性
3. **默认行为**：如果未提供结束时间，系统会使用开始时间作为结束时间
4. **合并策略**：当使用NPZ合并策略时，时间范围反映合并后的总时间跨度

## 测试配置

项目提供了 `config_plot_time_range_example.toml` 配置文件，演示了如何使用时间范围变量：

```bash
python run_cp_ppsd.py input/config_plot_time_range_example.toml
```

这将生成包含完整时间范围信息的图像文件名，便于数据管理和追踪。 