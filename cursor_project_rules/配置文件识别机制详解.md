# 配置文件识别机制详解

## 概述

CP_PPSD 项目采用智能配置文件识别系统，能够自动区分计算型配置和绘图型配置，支持灵活的文件命名和混合执行模式。

## 设计原则

1. **双重识别机制**：结合文件名约定和内容特征检测
2. **容错性强**：支持非标准命名的配置文件
3. **混合执行**：单次命令可处理多种类型配置
4. **执行顺序优化**：先计算后绘图的逻辑顺序

## 技术实现

### 1. 识别算法

#### 计算型配置识别
```python
def _is_calculation_config(self, config: Dict) -> bool:
    """
    识别计算型配置文件
    
    Args:
        config: 配置字典，包含 _file_path 键
        
    Returns:
        bool: True 表示计算型配置
        
    识别条件（满足任一）：
    1. 文件名以 '_calc.toml' 结尾
    2. 文件名为 'config.toml'
    3. 包含 'mseed_pattern' 参数
    """
    file_path = config.get('_file_path', '')
    return (file_path.endswith('_calc.toml') or 
            file_path.endswith('config.toml') or
            'mseed_pattern' in config)
```

#### 绘图型配置识别
```python
def _is_plot_config(self, config: Dict) -> bool:
    """
    识别绘图型配置文件
    
    Args:
        config: 配置字典，包含 _file_path 键
        
    Returns:
        bool: True 表示绘图型配置
        
    识别条件（满足任一）：
    1. 文件名以 '_plot.toml' 结尾
    2. 包含 'input_npz_dir' 参数
    3. args 段包含 'plot_type' 参数
    """
    file_path = config.get('_file_path', '')
    return (file_path.endswith('_plot.toml') or 
            'input_npz_dir' in config or
            'plot_type' in config.get('args', {}))
```

### 2. 配置文件分类处理

#### 分类逻辑
```python
def _classify_configs(self, configs: List[Dict]) -> Tuple[List[Dict], List[Dict]]:
    """
    将配置文件分类为计算型和绘图型
    
    Args:
        configs: 配置文件列表
        
    Returns:
        Tuple[List[Dict], List[Dict]]: (计算型配置, 绘图型配置)
    """
    calc_configs = []
    plot_configs = []
    
    for config in configs:
        if self._is_calculation_config(config):
            calc_configs.append(config)
        elif self._is_plot_config(config):
            plot_configs.append(config)
        else:
            # 默认视为计算型配置
            calc_configs.append(config)
            
    return calc_configs, plot_configs
```

#### 执行顺序
```python
def process_configs(self, config_files: List[str]) -> None:
    """
    按类型顺序处理配置文件
    
    执行顺序：
    1. 加载所有配置文件
    2. 分类为计算型和绘图型
    3. 先执行所有计算型配置
    4. 再执行所有绘图型配置
    """
    # 1. 加载配置
    configs = [self._load_config(f) for f in config_files]
    
    # 2. 分类
    calc_configs, plot_configs = self._classify_configs(configs)
    
    # 3. 先执行计算
    for config in calc_configs:
        self._process_calculation(config)
        
    # 4. 再执行绘图
    for config in plot_configs:
        self._process_plotting(config)
```

## 识别特征详解

### 计算型配置特征

#### 文件名特征
- `config.toml` - 默认计算配置文件
- `*_calc.toml` - 明确标识的计算配置
- 示例：`station_calc.toml`, `data_processing_calc.toml`

#### 内容特征
```toml
# 必需参数
mseed_pattern = "./data/*.mseed"
inventory_path = "./input/BJ.dataless"
output_dir = "./output/npz"

# PPSD计算参数
ppsd_length = 3600.0
overlap = 0.5
period_step_octaves = 0.125

# 数据处理参数
merge_method = 0
# merge_fill_value = 0.0
```

### 绘图型配置特征

#### 文件名特征
- `config_plot.toml` - 默认绘图配置文件
- `*_plot.toml` - 明确标识的绘图配置
- 示例：`style_plot.toml`, `comparison_plot.toml`

#### 内容特征（分组结构）
```toml
[global]
show_plot = true
save_plot = true
dpi = 300

[paths]
input_npz_dir = "./output/npz/"
inventory_path = "./input/BJ.XML"
output_dir = "./output/plots/"

[plotting]
plot_type = "spectrogram"
colormap = "viridis"

[args]
plot_type = "spectrogram"
```

#### 内容特征（传统结构）
```toml
# 关键识别参数
input_npz_dir = "./output/npz/"
plot_type = "spectrogram"

# 其他绘图参数
show_plot = true
save_plot = true
dpi = 300
```

## 使用案例

### 1. 标准用法
```bash
# 单独计算
python run_cp_ppsd.py config.toml

# 单独绘图
python run_cp_ppsd.py config_plot.toml

# 计算+绘图
python run_cp_ppsd.py config.toml config_plot.toml
```

### 2. 批量处理
```bash
# 多站点计算
python run_cp_ppsd.py \
    station1_calc.toml \
    station2_calc.toml \
    station3_calc.toml

# 多样式绘图
python run_cp_ppsd.py \
    standard_plot.toml \
    detailed_plot.toml \
    comparison_plot.toml
```

### 3. 混合处理
```bash
# 完整工作流
python run_cp_ppsd.py \
    data_calc.toml \
    standard_plot.toml \
    custom_plot.toml
```

## 错误处理机制

### 1. 文件级错误
- **文件不存在**：记录错误，跳过该文件
- **格式错误**：记录错误，跳过该文件
- **权限错误**：记录错误，跳过该文件

### 2. 识别级错误
- **类型无法确定**：默认视为计算型配置
- **参数缺失**：使用默认值或跳过该配置
- **参数冲突**：优先使用内容特征

### 3. 执行级错误
- **计算失败**：记录错误，继续处理其他配置
- **绘图失败**：记录错误，继续处理其他配置
- **输出目录创建失败**：尝试创建或使用默认目录

## 扩展机制

### 1. 新增识别特征
可通过修改识别函数添加新的识别特征：

```python
def _is_calculation_config(self, config: Dict) -> bool:
    # 现有逻辑
    file_path = config.get('_file_path', '')
    basic_check = (file_path.endswith('_calc.toml') or 
                  file_path.endswith('config.toml') or
                  'mseed_pattern' in config)
    
    # 新增特征检测
    advanced_check = (
        'ppsd_length' in config or
        'time_of_weekday' in config or
        config.get('mode', '') == 'calculation'
    )
    
    return basic_check or advanced_check
```

### 2. 自定义分类规则
用户可通过配置文件指定分类规则：

```toml
[meta]
config_type = "calculation"  # 或 "plotting"
priority = 1  # 执行优先级
```

## 性能优化

### 1. 配置缓存
- 避免重复解析相同配置文件
- 缓存识别结果

### 2. 并行处理
- 同类型配置可并行执行
- 计算型配置间无依赖时可并行

### 3. 延迟加载
- 仅在需要时加载配置内容
- 支持大量配置文件的处理

## 调试和诊断

### 启用详细日志
```bash
python run_cp_ppsd.py --verbose config.toml config_plot.toml
```

### 配置文件验证
```python
def validate_config_classification():
    """验证配置文件分类是否正确"""
    configs = load_all_configs()
    for config in configs:
        file_path = config.get('_file_path', '')
        is_calc = _is_calculation_config(config)
        is_plot = _is_plot_config(config)
        
        print(f"文件: {file_path}")
        print(f"计算型: {is_calc}")
        print(f"绘图型: {is_plot}")
        print("-" * 40)
``` 