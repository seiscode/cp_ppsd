# 波形频谱绘图工具重构报告

## 执行日期
2025-01-30 (初始重构)  
2025-01-30 (文件名简化更新)

## 重构概述

本次重构将原有的快速版本波形频谱绘图工具（`plot_waveform_spectrum_fast.py`）标准化为主要版本（`plot_waveform_spectrum.py`），删除了原有的低效版本，统一了工具链。

**最新更新**: 进一步简化了输出文件名，移除了模式标识后缀，使文件命名更加简洁统一。

## 重构内容

### 1. 文件重命名和清理

#### 操作步骤：
1. **删除原版本**: 删除 `plot_waveform_spectrum.py`（低效版本）
2. **重命名快速版本**: 将 `plot_waveform_spectrum_fast.py` 重命名为 `plot_waveform_spectrum.py`
3. **内容优化**: 移除标题中的 "Fast Mode" 标识，使其成为标准版本

#### 文件变更：
- `plot_waveform_spectrum.py` (旧版本)
- `plot_waveform_spectrum_fast.py` (快速版本)
- `plot_waveform_spectrum.py` (新标准版本)

### 2. 功能特性保留

重构后的标准版本保留了所有优化功能：

#### 核心功能：
- **三子图布局**: 时域波形图（上）+ 频域频谱图（中）+ 时频频谱图（下）
- **智能数据采样**: 根据性能模式自动优化绘图点数
- **Gap自动处理**: 检测数据间隙并进行零填充
- **性能模式选择**: 快速模式（默认）和质量模式（-q参数）

#### 优化特性：
- **频率范围限制**: 频谱图纵轴限制在0.1-50Hz
- **颜色条对齐**: 精确控制颜色条位置，与上面两图右边缘对齐
- **布局优化**: 颜色条宽度2%，间距0.05，视觉效果更佳

### 3. 技术参数

#### 性能模式对比：

| 参数 | 快速模式 (默认) | 质量模式 (-q) |
|------|----------------|---------------|
| 图像尺寸 | 10×12 inches | 12×14 inches |
| DPI | 150 | 200 |
| 最大波形点数 | 10,000 | 50,000 |
| FFT最大点数 | 8,192 | 16,384 |
| 频谱图NFFT | 512 | 1024 |
| 光栅化 | 是 | 否 |
| 处理速度 | ~3.5s/文件 | 较慢 |

#### 输出文件格式：
```
{网络}_{台站}_{通道}_{时间}.png
```
例如：`BJ_BBS_BHZ_20250325_160001.png`

**最新变更 (2025-01-30)**:
- **修改前**: `BJ_BBS_BHZ_20250325_160001_fast.png` / `BJ_BBS_BHZ_20250325_160001_quality.png`
- **修改后**: `BJ_BBS_BHZ_20250325_160001.png` (统一格式)

### 4. 标题优化

#### 修改内容：
- **频谱图标题**: `'Spectrogram (Fast Mode)'` → `'Spectrogram'`
- **工具描述**: 移除 "(高速版)" 标识，使其成为标准工具

#### 代码变更：
```python
# 修改前
ax3.set_title('Spectrogram (Fast Mode)', fontsize=11)

# 修改后  
ax3.set_title('Spectrogram', fontsize=11)
```

## 测试验证

### 测试命令：
```bash
python3 plot_waveform_spectrum.py ./data -o ./output/waveforms_new
```

### 测试结果：
- **处理文件数**: 5个MinISEED文件
- **总处理时间**: 17.31秒
- **平均处理时间**: 3.46秒/文件
- **成功率**: 100% (5/5)
- **Gap处理**: 成功检测和填充22, 30, 0, 2, 45个gaps

### 输出质量：
- **图像质量**: 150 DPI，适合快速查看和分析
- **文件大小**: 优化的图像尺寸和光栅化渲染
- **布局美观**: 三子图完美对齐，信息丰富

## 文档更新

### 1. README_plot_waveform_spectrum.md 更新
- 完全重写文档，反映新的三子图布局
- 添加性能模式对比表
- 更新使用示例和技术参数
- 增加技术亮点和故障排除章节

### 2. 项目知识库更新
- 在 `cursor_project_rules/00_PROJECT_OVERVIEW.md` 中添加新工具组件描述
- 创建工具集成架构图
- 说明与PPSD工具的协同关系

## 重构效果

### 1. 工具链简化
- **统一入口**: 只保留一个主要的波形频谱绘图工具
- **功能完整**: 集成了所有优化功能和性能模式
- **用户友好**: 简化的文件名和清晰的功能定位

### 2. 性能提升
- **处理速度**: 保持快速模式的高效处理速度（~3.5s/文件）
- **Gap处理**: 自动检测和填充，显著改善数据完整性
- **内存优化**: 智能采样减少内存使用

### 3. 视觉效果改进
- **布局对齐**: 三个子图右边缘完美对齐
- **颜色条优化**: 更窄的颜色条（2%宽度）和适当间距（0.05）
- **频率聚焦**: 频谱图限制在0.1-50Hz，突出重要频段

## 技术亮点

### 1. Gap处理优化
```python
# 自动检测gaps
gaps = st.get_gaps()

# 零填充合并
st.merge(method=0, fill_value=0)
```

### 2. 颜色条精确定位
```python
# 使用axes_grid1精确控制颜色条位置
from mpl_toolkits.axes_grid1 import make_axes_locatable
divider = make_axes_locatable(ax3)
cax = divider.append_axes("right", size="2%", pad=0.05)
```

### 3. 智能数据采样
```python
# 根据性能模式调整采样
def downsample_for_plot(data, times, max_points):
    if len(data) <= max_points:
        return data, times
    step = len(data) // max_points
    indices = np.arange(0, len(data), step)
    return data[indices], times[indices] if times is not None else None
```

## 后续计划

### 1. 功能扩展
- 考虑添加更多频域分析功能
- 支持更多地震数据格式
- 增加批量处理的进度显示

### 2. 性能优化
- 探索并行处理大批量文件
- 优化内存使用模式
- 考虑GPU加速FFT计算

### 3. 用户体验
- 添加配置文件支持
- 实现更详细的日志记录
- 考虑添加交互式参数调整

## 总结

本次重构成功实现了以下目标：

1. **工具链统一**: 消除了版本混乱，提供单一高效的波形频谱分析工具
2. **功能完整**: 保留了所有先进功能，包括三子图布局、智能采样、Gap处理
3. **性能优化**: 维持了快速处理能力，同时提供质量模式选择
4. **视觉改进**: 优化了图像布局和对齐效果
5. **文档完善**: 全面更新了用户文档和技术文档

新的标准版本工具为BJ台网MinISEED数据分析提供了更加专业、高效的可视化解决方案。

## 最新更新记录

### 2025-01-30 - 文件名简化优化

#### 变更内容：
- **文件命名统一**: 移除输出文件名中的模式标识（`_fast` / `_quality`）
- **代码简化**: 修改文件名生成逻辑，统一为 `{网络}_{台站}_{通道}_{时间}.png` 格式
- **用户体验**: 简化文件管理，避免因模式不同导致的文件名冗余

#### 技术实现：
```python
# 修改前
combined_file = os.path.join(output_dir, 
    f"{network}_{station_name}_{tr.stats.channel}_{start_time_str}_{mode}.png")

# 修改后
combined_file = os.path.join(output_dir, 
    f"{network}_{station_name}_{tr.stats.channel}_{start_time_str}.png")
```

#### 影响说明：
- **模式信息保留**: 性能模式信息仍在图像内部的信息框中显示
- **功能完整**: 不影响快速模式和质量模式的功能差异
- **向后兼容**: 新生成的文件名更加简洁，便于批量管理 