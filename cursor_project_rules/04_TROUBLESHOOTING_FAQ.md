# 04_TROUBLESHOOTING_FAQ.md - 常见问题解答

本文档收集了 `cp_ppsd` 项目在使用和开发过程中可能遇到的常见问题及其解决方案。如果您遇到未在此处列出的问题，请考虑将其添加到本文档中，或通过项目 Issue 跟踪系统报告。

## 目录
1.  [安装与环境问题](#1-安装与环境问题)
2.  [配置与参数问题](#2-配置与参数问题)
3.  [数据处理与计算问题](#3-数据处理与计算问题)
4.  [绘图与输出问题](#4-绘图与输出问题)
5.  [性能问题](#5-性能问题)
6.  [开发与贡献问题](#6-开发与贡献问题)

---

## 1. 安装与环境问题

*   **Q1.1: Python 版本不兼容怎么办？**
    *   **A**: 本项目推荐使用 Python 3.12.x (详见 `01_DEVELOPMENT_ENVIRONMENT.md`)。如果您的 Python 版本过低，请升级 Python。如果过高且遇到特定不兼容问题（理论上较少见），请考虑使用 `pyenv` 等工具管理多个 Python 版本，并为本项目创建指定版本的虚拟环境。

*   **Q1.2: 依赖库安装失败（如 ObsPy）？**
    *   **A**: 
        1.  确保您已激活项目的虚拟环境 (详见 `01_DEVELOPMENT_ENVIRONMENT.md`)。
        2.  检查网络连接。ObsPy 及其某些依赖 (如 NumPy, SciPy) 可能较大。
        3.  部分 ObsPy 依赖可能需要编译环境（如C编译器）。请参考 [ObsPy 官方安装文档](https://docs.obspy.org/master/install/index.html) 确保系统满足其编译依赖。
        4.  尝试更新 `pip` 和 `setuptools`: `pip install --upgrade pip setuptools`。
        5.  如果特定库安装失败，查看错误信息，可能需要安装系统级的开发库 (如 `libxml2-dev`, `libxslt1-dev` for lxml, `liblapack-dev`, `libblas-dev`, `gfortran` for SciPy)。

*   **Q1.3: `run_cp_ppsd.py` 脚本运行时提示找不到模块 (ModuleNotFoundError)？**
    *   **A**: 
        1.  确认您已在项目根目录下，并且已激活包含项目依赖的虚拟环境。
        2.  确认所有依赖已通过 `pip install -r requirements.txt` 正确安装到当前虚拟环境中。
        3.  检查脚本内部的导入语句是否正确，以及 `PYTHONPATH` 是否有异常设置（通常不应需要手动设置 `PYTHONPATH`）。

## 2. 配置与参数问题

*   **Q2.1: TOML 配置文件格式错误导致脚本无法启动？**
    *   **A**: 
        1.  仔细检查您的 `.toml` 文件语法。常见的错误包括：
            *   忘记 `=` 号或使用了 `:`。
            *   字符串未使用引号，或引号不匹配。
            *   列表忘记使用方括号 `[]` 或元素间缺少逗号。
            *   布尔值 `true`/`false` 写成了 `True`/`False` (TOML 标准是小写)。
            *   日期时间格式不符合 TOML 标准或脚本预期 (通常是 ISO 8601)。
        2.  可以使用在线 TOML 验证器检查文件格式。
        3.  参考 `产品需求文档：PDF计算软件.md` 中提供的配置文件示例。

*   **Q2.2: 某个配置参数似乎没有生效？**
    *   **A**: 
        1.  **核对参数名称和位置**: 确保参数名完全正确（包括大小写和下划线），并且位于正确的表中（例如，顶层参数 vs. `[args]` 表内的参数）。
        2.  **配置文件类型**: 确认您使用的配置文件类型（计算型 `config.toml` vs. 绘图型 `config_plot.toml`) 是否支持您想要修改的参数。例如，`ppsd_length` 主要由计算型配置控制，而 `show_noise_models` 由绘图型配置控制。
        3.  **参数作用域**: 有些参数是全局的（如`log_level`），有些是特定于命令或绘图类型的。
        4.  **默认值**: 如果参数未在配置文件中明确指定，脚本会使用其内置的默认值。检查默认行为是否与您的预期不符。
        5.  **注释**: 确认参数行没有被意外注释掉 (以 `#` 开头)。
        6.  **日志级别**: 将 `log_level` 设置为 `DEBUG`，运行脚本并查看日志，通常可以看到脚本加载和解析配置文件的详细过程，以及参数的实际取值。

*   **Q2.3: `output_filename_pattern` 或 `output_npz_filename_pattern` 中的占位符没有正确替换？**
    *   **A**: 
        1.  确保占位符的名称正确，例如 `{network}`, `{station}`, `{datetime}`, `{plot_type}` (仅绘图时)。
        2.  这些占位符的值通常从 PPSD 对象的元数据或处理上下文中获取。如果原始数据缺少相应的元数据（例如，MiniSEED 文件没有嵌入台站信息，或者 StationXML 中信息不全），则相应的占位符可能无法被替换。检查输入数据和 `inventory_path` 的完整性。
        3.  对于 `{plot_type}`，它仅在 `config_plot.toml` 的 `output_filename_pattern` 中有意义，并且会根据 `[args].plot_type` 列表中的每个类型被替换。

## 3. 数据处理与计算问题

(此部分内容可参考 `产品需求文档：PDF计算软件.md` 中的 6.4 和 6.5 节进行扩充)

*   **Q3.1: PPSD 结果异常，噪声水平过高/过低，或与参考模型差异巨大？**
    *   **A**: 这是最复杂的问题之一，通常与输入数据或仪器响应有关。
        1.  **仪器响应文件 (`inventory_path`)**: 这是首要检查点。确保其准确、完整，并且与正在处理的数据严格对应 (SEED ID, 有效时间)。检查增益、单位、极零点/系数。参考 `产品需求文档：PDF计算软件.md` 第 6.5 节 “仪器响应问题导致单位或量级错误”。
        2.  **数据质量**: 检查原始波形是否有明显异常、尖峰、数据中断。尝试设置 `skip_on_gaps = true`。
        3.  **数据单位**: 确认原始数据单位与仪器响应中定义的输入单位一致。
        4.  **SEED ID 匹配**: 确保波形数据与仪器响应文件中的 SEED ID 完全一致。
        5.  **`special_handling` 参数**: 仅在处理特定仪器（如环形激光器、水听器）时使用，对于标准地震计通常应为 `None`。

*   **Q3.2: 计算出的 PPSD 周期/频率范围不符合预期？**
    *   **A**: 
        1.  检查计算配置文件 (`config.toml`) 中的 `[args].period_limits`。这是 PPSD 对象本身计算的范围。
        2.  如果问题在绘图上，还需检查绘图配置文件 (`config_plot.toml`) 中的 `[args].period_lim`，它控制绘图显示的X轴范围。
        3.  确认输入数据的采样率是否满足奈奎斯特采样定理，以解析期望的最短周期（最高频率）。

*   **Q3.3: MiniSEED 文件或目录找不到 (`mseed_pattern`)？**
    *   **A**: 
        1.  检查 `mseed_pattern` 路径是否正确。相对路径是相对于脚本运行的位置，建议使用绝对路径或相对于配置文件的清晰相对路径。
        2.  如果是 glob 模式 (如 `*.mseed`)，确保模式能正确匹配目标文件。
        3.  如果是目录，脚本会递归搜索。如果文件很多或目录很深，可能需要一些时间。
        4.  检查文件权限。

*   **Q3.4: StationXML 文件找不到或无效 (`inventory_path`)？**
    *   **A**: 
        1.  检查 `inventory_path` 路径是否正确。
        2.  确保文件是有效的 StationXML 格式 (或其他 ObsPy 支持的元数据格式)。可以使用 ObsPy 的 `read_inventory()` 进行初步验证。
        3.  检查文件权限。

## 4. 绘图与输出问题

*   **Q4.1: 没有生成期望的图像文件？**
    *   **A**: 
        1.  确认您使用的是**绘图型配置文件** (`config_plot.toml`)，或者组合配置中包含了绘图型配置。
        2.  检查 `output_dir` 是否指定正确，以及脚本是否有写入该目录的权限。
        3.  检查日志（设置为 `DEBUG` 级别）看是否有关于绘图的错误信息。
        4.  确保 `[args].plot_type` 参数设置正确。如果 `plot_type` 是一个列表，脚本会为每种类型生成一个图。
        5.  检查输入 NPZ 文件是否存在且有效 (如果绘图配置依赖于预计算的 NPZ)。`input_npz_dir` 是否指向了正确的 NPZ 文件目录。

*   **Q4.2: 图像的颜色映射 (cmap) 或其他绘图参数不符合预期？**
    *   **A**: 
        1.  仔细检查绘图配置文件 (`config_plot.toml`) `[args]` 部分对应的绘图参数，例如 `standard_cmap`, `spectrogram_cmap`, `clim`, `period_lim` 等。
        2.  确认参数名和值是否符合 `产品需求文档：PDF计算软件.md` 中的描述。
        3.  有些参数是特定于某种 `plot_type` 的，例如 `clim` 主要用于 `spectrogram`。

*   **Q4.3: NPZ 文件没有生成？**
    *   **A**: 
        1.  确认您使用的是**计算型配置文件** (`config.toml`)，或者组合配置中包含了计算型配置。
        2.  检查 `output_dir` 是否指定正确，以及脚本是否有写入该目录的权限。
        3.  检查日志看是否有关于PPSD计算或NPZ保存的错误信息。

*   **Q4.4: 输出文件名中的时间信息不正确？**
    *   **A**: 
        1.  **时间来源**: 从2025年5月27日的更新开始，输出文件名中的时间信息来自MiniSEED数据的开始时间，而不是处理时间。这确保文件名能准确反映数据的实际时间范围。
        2.  **检查数据时间**: 如果文件名时间看起来不对，请检查原始MiniSEED文件的时间戳是否正确。可以使用ObsPy读取数据并查看 `trace.stats.starttime`。
        3.  **时区问题**: MiniSEED数据通常使用UTC时间。确认您的预期时间是否考虑了时区差异。
        4.  **文件名模式**: 检查配置文件中的 `output_npz_filename_pattern` 或 `output_filename_pattern` 是否使用了正确的时间占位符（如 `{datetime}`, `{year}`, `{month}` 等）。

## 5. 性能问题

(此部分内容可参考 `产品需求文档：PDF计算软件.md` 中的第 5 节进行扩充)

*   **Q5.1: PPSD 计算时间过长？**
    *   **A**: 参考 `产品需求文档：PDF计算软件.md` 5.2 节“计算速度优化”中的建议，例如调整 `skip_on_gaps`, `overlap`, `period_limits`，或利用已计算的 NPZ 文件。

*   **Q5.2: 脚本运行时内存不足 (MemoryError)？**
    *   **A**: 参考 `产品需求文档：PDF计算软件.md` 5.1 节“内存优化”中的建议，例如调整 `ppsd_length`, `period_step_octaves`, `db_bins`。分块处理数据或增加系统内存也是解决方案。

## 6. 开发与贡献问题

*   **Q6.1: 如何提交代码或报告 Bug？**
    *   **A**: 请参考 `02_CODING_STANDARDS.md` 中的代码审查流程、分支策略和提交规范。Bug 通常通过项目的 Issue 跟踪系统报告。

*   **Q6.2: 我想添加一个新的特性，应该怎么做？**
    *   **A**: 
        1.  首先，建议通过 Issue 提出您的特性建议，与项目维护者讨论其可行性和实现方案。
        2.  遵循 `02_CODING_STANDARDS.md` 中的分支策略，从 `develop` 分支创建新的特性分支。
        3.  完成开发和本地测试后，编写或更新相应的单元/集成测试 (参考 `03_TESTING_GUIDELINES.md`)。
        4.  确保代码符合编码规范，并更新相关文档 (如 `产品需求文档：PDF计算软件.md` 或其他知识库文档)。
        5.  发起合并请求到 `develop` 分支，并参与代码审查。

---
*本文档会持续更新。* 