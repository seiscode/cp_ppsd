# run_plot_psd.py 使用说明文档

## 1. 程序概述

`run_plot_psd.py` 是一个专门用于分析和可视化PPSD（Probabilistic Power Spectral Density）数据的工具。它从NPZ文件中提取PSD值并生成详细的分析图表，为地震台站噪声分析提供直观的可视化结果。

### 1.1 主要功能
- **PPSD概率密度分布图**：使用清淡的Blues配色方案，显示噪声功率谱密度的概率分布
- **PSD值散点图**：使用清淡配色，展示PSD值的分布特征
- **各时间段PSD曲线对比**：显示不同时间段的PSD曲线，便于识别时间变化
- **中文字体支持**：自动检测和配置中文字体，确保图表标签正确显示

### 1.2 设计特点
- **清淡配色方案**：采用专业的清淡色彩，适合科学报告和学术展示
- **四合一布局**：在单张图像中集成多种分析视角
- **自动化处理**：支持命令行参数，便于批量处理和脚本集成
- **中文本地化**：完整支持中文标签和说明文字

## 2. 安装和环境要求

### 2.1 依赖环境
- Python 3.8+
- conda环境：`seis`
- 必需的Python包：
  - numpy
  - matplotlib
  - obspy
  - datetime

### 2.2 中文字体支持
程序会自动检测和配置中文字体：
- 优先使用：WenQuanYi Micro Hei
- 备选字体：WenQuanYi Zen Hei, Noto Sans CJK
- 如果系统缺少中文字体，建议安装：
  ```bash
  sudo apt-get install fonts-wqy-microhei fonts-wqy-zenhei fonts-noto-cjk
  ```

## 3. 使用方法

### 3.1 基本语法
```bash
python run_plot_psd.py [NPZ文件路径] [输出目录]
```

### 3.2 使用示例

#### A. 使用默认NPZ文件
```bash
python run_plot_psd.py
```
- 自动查找默认NPZ文件：`./output/npz/PPSD_202503251600_BJ-DAX-00-BHZ.npz`
- 输出到默认目录：`./output/plots/`

#### B. 指定特定NPZ文件
```bash
python run_plot_psd.py ./output/npz/PPSD_202503251600_BJ-BBS-00-BHZ.npz
```
- 使用指定的NPZ文件
- 输出到默认目录：`./output/plots/`

#### C. 指定NPZ文件和输出目录
```bash
python run_plot_psd.py ./data/ppsd_data.npz ./custom_output/
```
- 使用指定的NPZ文件
- 输出到指定目录：`./custom_output/`

### 3.3 在conda环境中使用
```bash
# 方法1：直接在conda环境中运行
conda run -n seis python run_plot_psd.py

# 方法2：先激活环境再运行
conda activate seis
python run_plot_psd.py
```

### 3.4 错误处理
程序包含完善的错误处理机制：
- **文件不存在**：提示NPZ文件路径错误
- **数据格式错误**：提示NPZ文件格式不正确
- **权限问题**：提示输出目录权限不足
- **参数错误**：显示正确的使用方法

## 4. 输入要求

### 4.1 NPZ文件格式
- **来源**：由`run_cp_ppsd.py`计算生成的PPSD数据文件
- **格式**：NumPy NPZ格式，包含ObsPy PPSD对象的序列化数据
- **必需内容**：
  - PPSD概率密度矩阵
  - 频率/周期轴信息
  - 时间戳数据
  - 台站元数据

### 4.2 文件命名规范
NPZ文件应遵循标准命名格式：
```
PPSD_{datetime}_{network}-{station}-{location}-{channel}.npz
```
例如：`PPSD_202503260000_BJ-DAX-00-BHZ.npz`

### 4.3 数据质量要求
- NPZ文件必须包含有效的PPSD数据
- 至少包含一个完整的时间段数据
- 频率范围应覆盖地震学感兴趣的频段

## 5. 输出结果详解

### 5.1 输出文件

#### A. 主要分析图
**文件名格式**：`psd_analysis_{datetime}_{network}-{station}-{location}-{channel}.png`

**示例**：`psd_analysis_202503260000_BJ-DAX-00-BHZ.png`

**文件特性**：
- 分辨率：300 DPI，适合印刷质量
- 格式：PNG，支持透明背景
- 尺寸：16×12英寸，适合A4纸张

#### B. 中文字体测试图
**文件名**：`chinese_font_test.png`

**用途**：验证中文字体配置是否正确

### 5.2 四合一分析图详解

#### 子图1：PPSD概率密度分布（左上）

**功能说明**：
- 显示噪声功率谱密度的概率分布
- X轴：频率（Hz），对数坐标
- Y轴：功率谱密度（dB）
- 颜色：概率密度，使用Blues清淡配色

**物理意义**：
- **颜色深浅**：代表特定(频率,dB)组合出现的概率
- **水平条带**：表示稳定的宽频噪声源（如海洋微震、风噪声）
- **垂直条带**：表示窄频噪声源（如电力线干扰、机械振动）
- **概率峰值**：对应该频率的典型噪声水平

**分析要点**：
- 与Peterson噪声模型（NLNM/NHNM）对比
- 识别主要噪声源类型
- 评估台站背景噪声水平
- 检测异常噪声特征

#### 子图2：PSD值散点图（右上）

**功能说明**：
- 以散点形式展示所有PSD值的分布
- X轴：频率（Hz），对数坐标
- Y轴：功率谱密度（dB）
- 颜色：概率权重，使用Blues清淡配色
- 点大小：固定，便于观察分布密度

**物理意义**：
- **散点密度**：反映数据的统计分布特性
- **垂直分布**：显示每个频率点的噪声变化范围
- **异常点**：可能指示特殊事件或仪器问题
- **整体形状**：反映台站的噪声特征谱

**分析要点**：
- 识别噪声水平的变异性
- 检测异常高或低的PSD值
- 评估数据的统计稳定性
- 与概率密度图互补验证

#### 子图3：各时间段PSD曲线对比（左下）

**功能说明**：
- 显示不同时间段的PSD曲线叠加
- X轴：频率（Hz），对数坐标
- Y轴：功率谱密度（dB）
- 颜色：时间序列，使用viridis配色区分
- 透明度：根据数据质量自动调整

**物理意义**：
- **曲线变化**：反映噪声水平的时间演化
- **曲线聚集**：表示稳定的噪声环境
- **曲线分散**：表示噪声水平变化较大
- **异常曲线**：可能指示特殊事件或仪器故障

**分析要点**：
- 识别时间变化模式
- 检测异常时间段
- 评估噪声稳定性
- 分析环境影响因素

#### 子图4：预留位置（右下）

**当前状态**：显示"时间序列分析(功能已移除)"

**设计目的**：
- 保持四合一布局的完整性
- 为未来功能扩展预留空间
- 明确告知用户该功能状态

## 6. 应用场景

### 6.1 台站噪声评估
- **目的**：评估地震台站的背景噪声水平
- **方法**：与Peterson噪声模型对比
- **指标**：噪声水平是否在NLNM-NHNM范围内
- **应用**：台站选址、性能评价、质量控制

### 6.2 噪声源识别
- **目的**：识别和分类不同类型的噪声源
- **方法**：分析PPSD图中的特征模式
- **类型**：
  - 自然噪声：海洋微震、风噪声、地脉动
  - 人为噪声：交通、工业、电力干扰
- **应用**：环境影响评估、噪声控制

### 6.3 仪器性能诊断
- **目的**：检测地震仪器的性能问题
- **方法**：分析异常的频谱特征
- **问题类型**：
  - 仪器响应异常
  - 机械共振
  - 电子噪声
  - 安装问题
- **应用**：设备维护、故障诊断

### 6.4 长期监测分析
- **目的**：监测台站噪声的长期变化趋势
- **方法**：对比不同时期的PPSD结果
- **关注点**：
  - 季节性变化
  - 环境变化影响
  - 设备老化趋势
- **应用**：台站管理、预防性维护

### 6.5 科学研究支持
- **目的**：为地震学研究提供噪声分析支持
- **应用领域**：
  - 地震检测能力评估
  - 信号处理算法优化
  - 台网设计优化
  - 数据质量控制

## 7. 最佳实践

### 7.1 数据准备
1. **确保NPZ文件质量**：
   - 使用标准的PPSD计算参数
   - 确保足够的数据时长
   - 验证仪器响应文件正确性

2. **批量处理策略**：
   - 建立标准化的文件命名规范
   - 使用脚本自动化处理多个文件
   - 建立质量控制检查点

### 7.2 结果解读
1. **系统性分析**：
   - 先观察整体特征，再关注细节
   - 结合多个子图进行综合判断
   - 与已知参考标准对比

2. **异常识别**：
   - 关注明显偏离正常范围的特征
   - 分析异常的频率和时间特性
   - 结合台站环境信息判断原因

### 7.3 报告生成
1. **图像质量**：
   - 使用高分辨率输出（300 DPI）
   - 确保中文字体正确显示
   - 保持清淡配色的专业外观

2. **文档整合**：
   - 在报告中提供充分的背景信息
   - 解释分析方法和判断标准
   - 给出明确的结论和建议

## 8. 故障排除

### 8.1 常见问题

#### A. 中文字体显示问题
**症状**：图表中中文显示为方框或乱码

**解决方案**：
```bash
# 安装中文字体
sudo apt-get install fonts-wqy-microhei fonts-wqy-zenhei fonts-noto-cjk

# 清除matplotlib字体缓存
rm -rf ~/.cache/matplotlib
```

#### B. NPZ文件加载失败
**症状**：程序报错"无法加载NPZ文件"

**解决方案**：
1. 检查文件路径是否正确
2. 验证NPZ文件是否由正确的PPSD程序生成
3. 确认文件权限是否可读

#### C. 输出目录权限问题
**症状**：程序报错"无法写入输出文件"

**解决方案**：
```bash
# 检查目录权限
ls -la output/plots/

# 修改权限
chmod 755 output/plots/
```

#### D. 内存不足
**症状**：处理大文件时程序崩溃

**解决方案**：
1. 确保系统有足够的可用内存
2. 关闭其他内存密集型程序
3. 考虑分批处理大量数据

### 8.2 调试技巧

#### A. 启用详细输出
程序会自动显示处理进度和关键信息：
- NPZ文件加载状态
- 数据基本统计信息
- 图像保存确认

#### B. 验证输入数据
```python
import numpy as np
# 检查NPZ文件内容
data = np.load('your_file.npz', allow_pickle=True)
print(data.files)  # 查看包含的数组名称
```

#### C. 测试中文字体
程序会自动生成`chinese_font_test.png`文件，用于验证中文字体配置。

## 9. 技术参考

### 9.1 相关文档
- **ObsPy PPSD文档**：https://docs.obspy.org/packages/autogen/obspy.signal.spectral_estimation.PPSD.html
- **Peterson噪声模型**：USGS Open-File Report 93-322
- **项目主文档**：`cursor_project_rules/产品说明文档：PDF计算软件.md`

### 9.2 配色方案技术细节
- **Blues colormap**：matplotlib内置，提供从浅蓝到深蓝的渐变
- **viridis colormap**：科学可视化标准，色盲友好
- **透明度控制**：根据数据质量自动调整alpha值

### 9.3 性能优化
- **内存管理**：使用numpy数组操作，避免Python循环
- **图像压缩**：PNG格式，平衡质量和文件大小
- **字体缓存**：自动检测和缓存中文字体设置

## 10. 版本历史

### v1.0 (当前版本)
- 实现四合一PPSD分析图生成
- 支持清淡配色方案
- 完整的中文字体支持
- 移除时域分析功能，简化界面
- 支持命令行参数和批量处理

### 未来计划
- 增加更多配色方案选项
- 支持PDF格式输出
- 添加交互式图表功能
- 集成更多统计分析工具 